{% extends "base.html" %}
{% block title %}Take Attendance{% endblock %}
{% block content %}
<style>
    .flash-messages { margin-bottom: 20px; }
    .flash-message { padding: 15px; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; display: flex; align-items: center; gap: 10px; }
    .flash-message.success { background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; color: #28a745; }
    .flash-message.warning { background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107; color: #856404; }
    .flash-message.error { background: rgba(220, 53, 69, 0.1); border: 1px solid #dc3545; color: #dc3545; }
    .flash-message i { font-size: 1.2rem; }
</style>
<div class="container">
    <h1>Take Attendance</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">
                        <i class="fas {{ 'fa-check-circle' if category == 'success' else 'fa-exclamation-circle' if category == 'warning' else 'fa-times-circle' }}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <button onclick="capture()" class="btn btn-primary">Mark Attendance</button>
    <p><a href="{{ url_for('home') }}">Back to Dashboard</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
    async function loadModels() {
        await faceapi.nets.tinyFaceDetector.loadFromUri('/static/models/');
        await faceapi.nets.faceLandmark68Net.loadFromUri('/static/models/');
        await faceapi.nets.faceRecognitionNet.loadFromUri('/static/models/');
        startVideo();
    }
    function startVideo() {
        navigator.mediaDevices.getUserMedia({ video: {} })
            .then(stream => {
                document.getElementById('video').srcObject = stream;
            })
            .catch(err => {
                console.error("Error accessing webcam:", err);
                alert("Cannot access webcam. Please check permissions.");
            });
    }
    async function capture() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const imageData = canvas.toDataURL('image/jpeg');
        fetch('/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageData })
        }).then(response => response.json())
          .then(data => {
              if (data.category === 'success') {
                  window.location.href = '/home';
              } else {
                  alert(data.message);
              }
          });
    }
    loadModels();
</script>
{% endblock %}
